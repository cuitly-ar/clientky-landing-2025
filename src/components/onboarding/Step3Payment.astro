---
import { getLanguage, t } from '../../i18n/utils';

const lang = getLanguage(Astro.url);

const summaryDictionary = {
  perMonth: t(lang, 'perMonth'),
  perYear: t(lang, 'perYear'),
  billingMonthly: t(lang, 'billingMonthlyLabel'),
  billingAnnual: t(lang, 'billingAnnualLabel'),
  badgeMonthly: t(lang, 'monthlyBilling'),
  badgeAnnual: t(lang, 'annualBilling'),
  defaultDescription: t(lang, 'stableGrowth')
};
---

<div class="max-w-2xl">
  <div class="mb-8">
    <h2 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">
      {t(lang, 'guaranteedGrowth')}
    </h2>
    <p class="text-gray-600">
      {t(lang, 'startGrowth')}
    </p>
  </div>

  <div id="selected-plan-card" class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-2xl p-6 mb-6 border-2 border-purple-200 shadow-inner">
    <div class="flex justify-between items-start mb-4">
      <div>
        <span class="inline-block px-3 py-1 bg-accent text-white text-xs font-bold rounded-full mb-2" id="plan-billing-badge">
          {t(lang, 'monthlyBilling')}
        </span>
        <h3 class="text-xl font-bold text-gray-900" id="plan-name-display">{t(lang, 'selectedPlan')}</h3>
        <p class="text-sm text-gray-600" id="plan-description-display">{t(lang, 'stableGrowth')}</p>
      </div>
      <div class="text-right">
        <p class="text-3xl font-extrabold text-gray-900">
          <span id="plan-price-value">$0</span>
          <span class="text-lg text-gray-600" id="plan-period-display">{t(lang, 'perMonth')}</span>
        </p>
      </div>
    </div>
    <p class="text-xs text-gray-600" id="plan-note-display">{t(lang, 'billingMonthlyLabel')}</p>
  </div>

  <div class="bg-white border border-gray-200 rounded-2xl p-6 space-y-4 shadow-xl">
    <div class="flex items-start gap-3 text-sm text-gray-600 bg-primary/5 rounded-2xl p-4 border border-primary/10">
      <span class="text-2xl" aria-hidden="true">ðŸ”’</span>
      <div>
        <p class="font-semibold text-gray-900">{t(lang, 'polarCheckoutNote')}</p>
        <p class="text-gray-500">{t(lang, 'polarCheckoutPaused')}</p>
      </div>
    </div>

    <button
      id="polar-checkout-button"
      type="button"
      class="w-full bg-gradient-to-r from-primary to-secondary text-white py-4 rounded-xl font-semibold shadow-lg transition-all duration-300 opacity-60 cursor-not-allowed"
      aria-disabled="true"
    >
      {t(lang, 'subscribeNow')}
    </button>
    <p class="text-sm text-gray-500 text-center" id="polar-checkout-warning">
      {t(lang, 'polarCheckoutPausedHint')}
    </p>
  </div>
</div>

<script type="application/json" id="step3-i18n">
  {JSON.stringify(summaryDictionary)}
</script>

<script>
  const i18nNode = document.getElementById('step3-i18n');
  let dictionary = {
    perMonth: 'per month',
    perYear: 'per year',
    billingMonthly: 'Billing monthly',
    billingAnnual: 'Billing annual',
    badgeMonthly: 'Monthly',
    badgeAnnual: 'Annual',
    defaultDescription: ''
  };

  if (i18nNode?.textContent) {
    try {
      dictionary = JSON.parse(i18nNode.textContent);
    } catch (error) {
      console.warn('No se pudo interpretar el diccionario de Step 3', error);
    }
  }

  const planNameDisplay = document.getElementById('plan-name-display');
  const planPriceValue = document.getElementById('plan-price-value');
  const planPeriodDisplay = document.getElementById('plan-period-display');
  const planNoteDisplay = document.getElementById('plan-note-display');
  const planBadgeDisplay = document.getElementById('plan-billing-badge');
  const planDescriptionDisplay = document.getElementById('plan-description-display');

  function updatePlanSummary(plan) {
    if (!plan) return;

    const formatter = new Intl.NumberFormat(
      document.documentElement.lang === 'es' ? 'es-AR' : 'en-US',
      { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }
    );

    const isAnnual = plan.billing === 'annual';
    const price = isAnnual ? plan.annualPrice : plan.monthlyPrice;

    planNameDisplay && (planNameDisplay.textContent = plan.name);
    planPriceValue && (planPriceValue.textContent = formatter.format(price));
    planPeriodDisplay && (planPeriodDisplay.textContent = isAnnual ? dictionary.perYear : dictionary.perMonth);
    planNoteDisplay && (planNoteDisplay.textContent = isAnnual ? dictionary.billingAnnual : dictionary.billingMonthly);
    planBadgeDisplay && (planBadgeDisplay.textContent = isAnnual ? dictionary.badgeAnnual : dictionary.badgeMonthly);
    if (planDescriptionDisplay) {
      planDescriptionDisplay.textContent = plan.description || dictionary.defaultDescription;
    }
  }

  const storedPlan = sessionStorage.getItem('selectedPlan');
  if (storedPlan) {
    try {
      updatePlanSummary(JSON.parse(storedPlan));
    } catch (error) {
      console.warn('No se pudo cargar el plan guardado', error);
    }
  }

  window.addEventListener('onboarding:plan-ready', (event) => {
    const planEvent = event;
    updatePlanSummary(planEvent.detail?.plan);
  });

  const checkoutButton = document.getElementById('polar-checkout-button');
  checkoutButton?.addEventListener('click', () => {
    console.log('Checkout temporalmente deshabilitado.');
  });
</script>
