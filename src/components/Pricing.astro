---
import { getLanguage, t } from '../i18n/utils';
import { getPlans } from '../data/plans';

const lang = getLanguage(Astro.url);
const onboardingHref = lang === 'en' ? '/en/onboarding' : '/onboarding';
const onboardingEnabled = import.meta.env.DEV;
const currencyFormatter = new Intl.NumberFormat(
  lang === 'es' ? 'es-AR' : 'en-US',
  { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }
);
const plans = getPlans(lang);
const comparisonRows = [
  { key: 'followers', label: t(lang, 'comparisonFollowers') },
  { key: 'likes', label: t(lang, 'comparisonLikes') },
  { key: 'views', label: t(lang, 'comparisonViews') },
  { key: 'comments', label: t(lang, 'comparisonComments') },
  { key: 'bonus', label: t(lang, 'comparisonBonus') },
  { key: 'reports', label: t(lang, 'comparisonReports') },
  { key: 'support', label: t(lang, 'comparisonSupport') }
] as const;
---

<section id="precios" class="py-20 md:py-28 bg-gradient-to-br from-gray-50 via-purple-50 to-gray-100">
  <div class="container mx-auto px-6 lg:px-20">
    <div class="text-center mb-12 md:mb-16 max-w-3xl mx-auto">
      <p class="text-sm uppercase tracking-[0.3em] text-primary font-semibold mb-3">
        Clientky Plans
      </p>
      <h2 class="text-3xl md:text-4xl lg:text-5xl font-bold text-gray-900 mb-4">
        {t(lang, 'pricingTitle')}
      </h2>
      <p class="text-lg text-gray-600">
        {t(lang, 'pricingSubtitle')}
      </p>
    </div>

    <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-10">
      <div class="relative flex bg-white rounded-full p-1 shadow-lg border border-gray-200 w-full max-w-lg" data-billing-toggle>
        <span class="billing-indicator absolute top-1 bottom-1 left-1 w-1/2 rounded-full bg-gradient-to-r from-primary to-secondary transition-all duration-300"></span>
        <button
          type="button"
          class="billing-toggle active relative z-10 flex-1 px-6 py-3 rounded-full text-sm font-semibold text-white"
          data-billing="monthly"
        >
          {t(lang, 'monthlyBilling')}
        </button>
        <button
          type="button"
          class="billing-toggle relative z-10 flex-1 px-6 py-3 rounded-full text-sm font-semibold text-gray-500"
          data-billing="annual"
        >
          <span>{t(lang, 'annualBilling')}</span>
          <span class="block text-xs text-primary font-bold">{t(lang, 'annualSavings')}</span>
        </button>
      </div>
      <p class="text-sm text-gray-500">{t(lang, 'billingToggleHint')}</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 max-w-7xl mx-auto" data-onboarding-root>
      {plans.map((plan) => (
        <div
          class={`bg-white rounded-3xl p-8 lg:p-10 shadow-lg hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 relative border ${
            plan.featured ? 'border-primary/40 ring-1 ring-primary/40' : 'border-gray-100'
          }`}
          data-plan-card
        >
          {plan.featured && (
            <div class="absolute -top-4 left-1/2 -translate-x-1/2 bg-primary text-white px-6 py-2 rounded-full text-sm font-semibold shadow-lg">
              {t(lang, 'mostPopular')}
            </div>
          )}

          <div class="text-center mb-8">
            <h3 class="text-2xl font-bold text-gray-900 mb-2">{plan.name}</h3>
            <p class="text-gray-500 text-sm">{plan.description}</p>
            <div class="mt-6">
              <span
                class="text-5xl font-extrabold text-gray-900"
                data-plan-price
                data-monthly={plan.monthlyPrice}
                data-annual={plan.annualPrice}
              >
                {currencyFormatter.format(plan.monthlyPrice)}
              </span>
              <span
                class="text-xl text-gray-500 ml-2"
                data-plan-period
                data-month-label={t(lang, 'perMonth')}
                data-year-label={t(lang, 'perYear')}
              >
                {t(lang, 'perMonth')}
              </span>
            </div>
            <p
              class="text-xs text-gray-500 mt-2"
              data-billing-note
              data-month-label={t(lang, 'billingMonthlyLabel')}
              data-year-label={t(lang, 'billingAnnualLabel')}
            >
              {t(lang, 'billingMonthlyLabel')}
            </p>
          </div>

          <ul class="space-y-4 mb-10">
            {plan.features.map((feature) => {
              const isBonus = feature.trim().startsWith('+');
              const label = isBonus ? feature.replace(/^\+\s*/, '') : feature;
              return (
                <li class={`flex items-start gap-3 ${isBonus ? 'text-secondary' : ''}`}>
                  <span class={`text-xl font-bold flex-shrink-0 ${isBonus ? 'text-secondary' : 'text-secondary'}`}>
                    {isBonus ? '+' : 'âœ“'}
                  </span>
                  <span class={`leading-relaxed ${isBonus ? 'text-secondary font-semibold' : 'text-gray-700'}`}>
                    {label}
                  </span>
                </li>
              );
            })}
          </ul>

          <button
            type="button"
            aria-disabled={!onboardingEnabled}
            disabled={!onboardingEnabled}
            class={`w-full py-4 rounded-2xl font-semibold transition-all duration-300 ${
              plan.featured
                ? 'bg-gradient-to-r from-primary to-secondary text-white shadow-xl hover:scale-[1.02]'
                : 'bg-white text-primary border-2 border-primary hover:bg-primary hover:text-white'
            } ${onboardingEnabled ? '' : 'opacity-60 cursor-not-allowed pointer-events-none'}`}
            data-plan-id={plan.id}
            data-plan-name={plan.name}
            data-plan-monthly={plan.monthlyPrice}
            data-plan-annual={plan.annualPrice}
            data-plan-description={plan.description}
            data-onboarding={onboardingHref}
          >
            {onboardingEnabled ? t(lang, 'selectPlan') : t(lang, 'comingSoonAction')}
          </button>
        </div>
      ))}
    </div>
    {!onboardingEnabled && (
      <p class="text-center text-sm text-gray-500 mt-6">
        {t(lang, 'comingSoonNote')}
      </p>
    )}
  </div>

  <div class="container mx-auto px-6 lg:px-20 mt-12">
    <div class="bg-white rounded-3xl shadow-xl border border-gray-100 p-8">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6 mb-6">
        <div>
          <p class="text-sm uppercase tracking-[0.3em] text-primary font-semibold mb-2">{t(lang, 'comparisonTitle')}</p>
          <p class="text-gray-500">{t(lang, 'comparisonHint')}</p>
        </div>
        <button
          type="button"
          class="px-5 py-3 border border-primary text-primary rounded-full font-semibold hover:bg-primary hover:text-white transition-all duration-300"
          data-comparison-toggle
          data-show-label={t(lang, 'comparisonToggleShow')}
          data-hide-label={t(lang, 'comparisonToggleHide')}
        >
          {t(lang, 'comparisonToggleShow')}
        </button>
      </div>
      <div id="comparison-table" class="hidden overflow-x-auto">
        <table class="min-w-full text-left text-sm text-gray-700">
          <thead>
            <tr>
              <th class="py-3 pr-4 font-semibold text-gray-500">{t(lang, 'comparisonTitle')}</th>
              {plans.map((plan) => (
                <th class="py-3 px-4 font-semibold text-gray-900">{plan.name}</th>
              ))}
            </tr>
          </thead>
          <tbody>
            {comparisonRows.map((row) => (
              <tr class="border-t border-gray-100">
                <td class="py-4 pr-4 font-semibold text-gray-600">{row.label}</td>
                {plans.map((plan) => (
                  <td class="py-4 px-4 text-gray-800">{plan.comparison[row.key]}</td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</section>

<script define:vars={{ onboardingEnabledFlag: onboardingEnabled }}>
  const billingButtons = document.querySelectorAll('.billing-toggle');
  const priceElements = document.querySelectorAll('[data-plan-price]');
  const periodElements = document.querySelectorAll('[data-plan-period]');
  const noteElements = document.querySelectorAll('[data-billing-note]');
  const selectButtons = document.querySelectorAll('[data-plan-id]');
  const billingIndicator = document.querySelector('.billing-indicator');
  const comparisonToggle = document.querySelector('[data-comparison-toggle]');
  const comparisonTable = document.getElementById('comparison-table');
  const formatter = new Intl.NumberFormat(
    document.documentElement.lang === 'es' ? 'es-AR' : 'en-US',
    { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }
  );
  let currentBilling = 'monthly';

  function updateBillingUI() {
    billingButtons.forEach((btn) => {
      const targetBilling = btn.getAttribute('data-billing');
      const isActive = targetBilling === currentBilling;
      btn.classList.toggle('text-white', isActive);
      btn.classList.toggle('text-gray-500', !isActive);
    });

    if (billingIndicator) {
      billingIndicator.style.transform = currentBilling === 'monthly' ? 'translateX(0)' : 'translateX(100%)';
    }

    priceElements.forEach((priceEl) => {
      const monthly = Number(priceEl.getAttribute('data-monthly'));
      const annual = Number(priceEl.getAttribute('data-annual'));
      const amount = currentBilling === 'monthly' ? monthly : annual;
      priceEl.textContent = formatter.format(amount);
    });

    periodElements.forEach((periodEl) => {
      const monthLabel = periodEl.getAttribute('data-month-label') || '';
      const yearLabel = periodEl.getAttribute('data-year-label') || '';
      periodEl.textContent = currentBilling === 'monthly' ? monthLabel : yearLabel;
    });

    noteElements.forEach((noteEl) => {
      const monthLabel = noteEl.getAttribute('data-month-label') || '';
      const yearLabel = noteEl.getAttribute('data-year-label') || '';
      noteEl.textContent = currentBilling === 'monthly' ? monthLabel : yearLabel;
    });
  }

  billingButtons.forEach((btn) => {
    btn.addEventListener('click', () => {
      const next = btn.getAttribute('data-billing');
      if (next && next !== currentBilling) {
        currentBilling = next;
        updateBillingUI();
      }
    });
  });

  updateBillingUI();

  selectButtons.forEach((btn) => {
    btn.addEventListener('click', () => {
      if (!onboardingEnabledFlag) {
        return;
      }
      const planId = btn.getAttribute('data-plan-id');
      const planName = btn.getAttribute('data-plan-name');
      const monthly = Number(btn.getAttribute('data-plan-monthly'));
      const annual = Number(btn.getAttribute('data-plan-annual'));
      const onboardingPath = btn.getAttribute('data-onboarding') || '/onboarding';
      const description = btn.getAttribute('data-plan-description');

      if (!planId || !planName) return;

      const selectedPlan = {
        id: planId,
        name: planName,
        monthlyPrice: monthly,
        annualPrice: annual,
        billing: currentBilling,
        description
      };

      sessionStorage.setItem('selectedPlan', JSON.stringify(selectedPlan));
      const url = new URL(onboardingPath, window.location.origin);
      url.searchParams.set('plan', planId);
      url.searchParams.set('billing', currentBilling);
      window.location.href = url.pathname + url.search;
    });
  });

  comparisonToggle?.addEventListener('click', () => {
    if (!comparisonTable) return;
    const showLabel = comparisonToggle.getAttribute('data-show-label') || '';
    const hideLabel = comparisonToggle.getAttribute('data-hide-label') || '';
    const isHidden = comparisonTable.classList.toggle('hidden');
    comparisonToggle.textContent = isHidden ? showLabel : hideLabel;
  });
</script>

