---
import type { Language } from '../../i18n/translations';
import Layout from '../../layouts/Layout.astro';
import Stepper from '../../components/onboarding/Stepper.astro';
import SidePanel from '../../components/onboarding/SidePanel.astro';
import Step1SelectPlan from '../../components/onboarding/Step1SelectPlan.astro';
import Step2ConfigureUser from '../../components/onboarding/Step2ConfigureUser.astro';
import Step3Payment from '../../components/onboarding/Step3Payment.astro';
import { getLanguage } from '../../i18n/utils';
import { getPlans } from '../../data/plans';

interface Props {
  lang?: Language;
}

const { lang: forcedLang } = Astro.props;
const lang = forcedLang ?? getLanguage(Astro.url);
const pageTitle = lang === 'es' ? 'Configuración' : 'Setup';
const pageDescription = lang === 'es' ? 'Configura tu cuenta de Clientky' : 'Set up your Clientky account';
const homeHref = lang === 'en' ? '/en/' : '/';
const planParam = Astro.url.searchParams.get('plan');
const defaultStep = planParam ? 2 : 1;
const initialStep = Number(Astro.url.searchParams.get('step') || String(defaultStep));
const landingHref = lang === 'en' ? '/en/#precios' : '/#precios';
const serializedPlans = JSON.stringify(getPlans(lang));
---

<Layout title={`Clientky - ${pageTitle}`} description={pageDescription} lang={lang}>
  <div id="onboarding-root" class="min-h-screen bg-gray-50 pt-24 pb-12" data-initial-step={initialStep} data-landing={landingHref}>
    <div class="flex flex-col lg:flex-row max-w-7xl mx-auto gap-8 px-6 md:px-10">
      <div class="w-full lg:w-3/5 bg-white rounded-3xl shadow-xl p-6 md:p-10">
        <a href={homeHref} class="inline-flex items-center gap-2 text-2xl font-bold text-primary mb-8">
          Clientky<span class="text-gray-900">.</span>
        </a>

        <Stepper currentStep={initialStep} />

        <div id="onboarding-steps" class="mt-10 space-y-10">
          <section data-step-panel="1" class={initialStep === 1 ? '' : 'hidden'}>
            <Step1SelectPlan />
          </section>
          <section data-step-panel="2" class={initialStep === 2 ? '' : 'hidden'}>
            <Step2ConfigureUser />
          </section>
          <section data-step-panel="3" class={initialStep === 3 ? '' : 'hidden'}>
            <Step3Payment />
          </section>
        </div>
      </div>

      <SidePanel />
    </div>
  </div>

  <script type="application/json" id="plan-config">
    {serializedPlans}
  </script>
</Layout>

<script>
const onboardingRoot = document.getElementById('onboarding-root');
const stepPanels = document.querySelectorAll('[data-step-panel]');
const stepper = document.querySelector('[data-stepper]');
const stepIndicators = document.querySelectorAll('[data-step-index]');
const stepMarkers = document.querySelectorAll('[data-step-marker]');
const stepLabels = document.querySelectorAll('[data-step-label]');
  const planConfig = document.getElementById('plan-config');
  const MAX_STEP = 3;
  let currentStep = Number(onboardingRoot?.getAttribute('data-initial-step') || '1');
  const landingHref = onboardingRoot?.getAttribute('data-landing') || '/#precios';

  const planDictionary = {};
  if (planConfig?.textContent) {
    try {
      const parsed = JSON.parse(planConfig.textContent);
      parsed.forEach((plan) => {
        planDictionary[plan.id] = plan;
      });
    } catch (error) {
      console.warn('No se pudo leer la configuración de planes', error);
    }
  }

  function updateStepperVisual(step) {
    stepIndicators.forEach((indicator, index) => {
      const stepNumber = Number(indicator.getAttribute('data-step-index'));
      indicator.className = 'w-12 h-12 rounded-full flex items-center justify-center font-bold transition-all duration-300';
      if (stepNumber < step) {
        indicator.classList.add('bg-secondary', 'text-white');
      } else if (stepNumber === step) {
        indicator.classList.add('bg-primary', 'text-white', 'ring-4', 'ring-primary/20');
      } else {
        indicator.classList.add('bg-gray-200', 'text-gray-500');
      }

      const marker = stepMarkers[index];
      if (marker) {
        marker.textContent = stepNumber < step ? '✓' : String(stepNumber);
      }
    });

    stepLabels.forEach((label) => {
      const labelStep = Number(label.getAttribute('data-step-label'));
      label.classList.toggle('text-primary', labelStep === step);
      label.classList.toggle('text-gray-500', labelStep !== step);
    });
  }

  function setStep(step) {
    currentStep = Math.max(1, Math.min(MAX_STEP, step));
    stepPanels.forEach((panel) => {
      panel.classList.toggle('hidden', panel.getAttribute('data-step-panel') !== String(currentStep));
    });
    if (stepper) {
      stepper.setAttribute('data-current-step', String(currentStep));
    }
    updateStepperVisual(currentStep);

    const url = new URL(window.location.href);
    url.searchParams.set('step', String(currentStep));
    window.history.replaceState({}, '', url);
  }

  function broadcastPlan(plan) {
    window.dispatchEvent(new CustomEvent('onboarding:plan-ready', { detail: { plan } }));
  }

  function bootstrapFromUrl() {
    const url = new URL(window.location.href);
    const planParam = url.searchParams.get('plan');
    const billingParam = url.searchParams.get('billing') === 'annual' ? 'annual' : 'monthly';
    const stepParam = Number(url.searchParams.get('step') || '1');

    const storedPlan = sessionStorage.getItem('selectedPlan');
    if (storedPlan) {
    try {
      const parsedPlan = JSON.parse(storedPlan);
      broadcastPlan(parsedPlan);
      setStep(Math.max(2, stepParam));
      return;
    } catch (error) {
      sessionStorage.removeItem('selectedPlan');
    }
    }

    if (planParam && planDictionary[planParam]) {
      const planDef = planDictionary[planParam];
      const payload = {
        id: planDef.id,
        name: planDef.name,
        monthlyPrice: planDef.monthlyPrice,
        annualPrice: planDef.annualPrice,
        billing: billingParam,
        description: planDef.description
      };
      sessionStorage.setItem('selectedPlan', JSON.stringify(payload));
      broadcastPlan(payload);
      setStep(Math.max(2, stepParam));
      return;
    }

    window.location.href = landingHref;
    return;
  }

  function handleNavigate(event) {
    const detail = event?.detail || {};
    const targetStep = Number(detail.step);
    if (!Number.isNaN(targetStep)) {
      setStep(targetStep);
    }
  }

  function handlePlanUpdate(event) {
    const plan = event?.detail?.plan;
    if (!plan) return;
    sessionStorage.setItem('selectedPlan', JSON.stringify(plan));
    broadcastPlan(plan);
    setStep(2);
  }

  window.addEventListener('onboarding:navigate', handleNavigate);
  window.addEventListener('onboarding:update-plan', handlePlanUpdate);

  bootstrapFromUrl();
</script>

