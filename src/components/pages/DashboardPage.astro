---
import type { Language } from '../../i18n/translations';
import Layout from '../../layouts/Layout.astro';
import { getLanguage, t } from '../../i18n/utils';

interface Props {
  lang?: Language;
}

const { lang: forcedLang } = Astro.props;
const lang = forcedLang ?? getLanguage(Astro.url);
const homeHref = lang === 'en' ? '/en/' : '/';
const marketplaceAnchor = '#marketplace-grid';
const loginHref = lang === 'en' ? '/en/login/' : '/login/';

const defaultSection = 'overview';
const defaultMarketplacePlatform = 'instagram';

const navItems = [
  { key: 'overview', label: t(lang, 'dashboardNavOverview') },
  { key: 'orders', label: t(lang, 'dashboardNavOrders') },
  { key: 'marketplace', label: t(lang, 'dashboardNavMarketplace') },
  { key: 'reports', label: t(lang, 'dashboardNavReports') },
  { key: 'support', label: t(lang, 'dashboardNavSupport') },
  { key: 'plan', label: t(lang, 'dashboardNavPlan') },
  { key: 'settings', label: t(lang, 'dashboardNavSettings') },
];

const userProfile = {
  name: lang === 'es' ? 'Mariana Rivas' : 'Mariana Rivas',
  email: 'mariana@clientky.com',
  role: lang === 'es' ? 'Plan Starter activo' : 'Active Starter plan',
  avatar: 'https://images.unsplash.com/photo-1544723795-3fb6469f5b39?auto=format&fit=crop&w=200&q=60',
};

const preferredLanguages = [
  { value: 'es', label: t(lang, 'dashboardSettingsLanguageEs') },
  { value: 'en', label: t(lang, 'dashboardSettingsLanguageEn') },
];

const quantityFormatter = new Intl.NumberFormat(lang === 'es' ? 'es-AR' : 'en-US');
const currencyFormatter = new Intl.NumberFormat(lang === 'es' ? 'es-AR' : 'en-US', { style: 'currency', currency: 'USD' });

const serviceUnits = {
  followers: t(lang, 'marketFollowers'),
  likes: t(lang, 'marketLikes'),
  views: t(lang, 'marketViews'),
  comments: t(lang, 'marketComments'),
  live: t(lang, 'marketLiveStream'),
};

const baseFollowersPackages = [
  { id: 'followers-50', quantity: 50, price: 2.38 },
  { id: 'followers-100', quantity: 100, price: 3.44, compareAt: 6.14, discount: 44 },
  { id: 'followers-250', quantity: 250, price: 5.31, compareAt: 9.49, discount: 44 },
  { id: 'followers-500', quantity: 500, price: 8.44, compareAt: 15.06, discount: 44 },
  { id: 'followers-1000', quantity: 1000, price: 14.88, compareAt: 26.56, discount: 44 },
  { id: 'followers-2500', quantity: 2500, price: 30.94, compareAt: 55.25, discount: 44 },
];

const baseLikesPackages = [
  { id: 'likes-250', quantity: 250, price: 2.1 },
  { id: 'likes-500', quantity: 500, price: 3.6, compareAt: 6.7, discount: 46 },
  { id: 'likes-1000', quantity: 1000, price: 6.9, compareAt: 12.5, discount: 45 },
  { id: 'likes-2500', quantity: 2500, price: 15.9, compareAt: 28.0, discount: 43 },
];

const baseViewsPackages = [
  { id: 'views-1000', quantity: 1000, price: 1.9 },
  { id: 'views-5000', quantity: 5000, price: 5.5, compareAt: 9.8, discount: 44 },
  { id: 'views-10000', quantity: 10000, price: 9.5, compareAt: 16.9, discount: 44 },
  { id: 'views-25000', quantity: 25000, price: 21.5, compareAt: 36.0, discount: 40 },
];

const baseCommentsPackages = [
  { id: 'comments-25', quantity: 25, price: 4.5 },
  { id: 'comments-50', quantity: 50, price: 8.0, compareAt: 14.0, discount: 43 },
  { id: 'comments-100', quantity: 100, price: 14.5, compareAt: 25.0, discount: 42 },
];

const baseLivePackages = [
  { id: 'live-100', quantity: 100, price: 6.5 },
  { id: 'live-250', quantity: 250, price: 14.0, compareAt: 22.5, discount: 38 },
  { id: 'live-500', quantity: 500, price: 25.0, compareAt: 39.0, discount: 36 },
];

const marketplacePackages = {
  followers: baseFollowersPackages,
  likes: baseLikesPackages,
  views: baseViewsPackages,
  comments: baseCommentsPackages,
  live: baseLivePackages,
};

const marketplacePlatforms = {
  instagram: {
    label: t(lang, 'marketPlatformInstagram'),
    highlight: lang === 'es' ? 'Paquetes curados para IG.' : 'Curated packs for IG.',
    services: [
      { id: 'followers', icon: 'üìà', title: t(lang, 'marketFollowers'), description: t(lang, 'marketFollowersDesc'), packagesKey: 'followers' },
      { id: 'likes', icon: '‚ù§Ô∏è', title: t(lang, 'marketLikes'), description: t(lang, 'marketLikesDesc'), packagesKey: 'likes' },
      { id: 'views', icon: 'üé¨', title: t(lang, 'marketViews'), description: t(lang, 'marketViewsDesc'), packagesKey: 'views' },
      { id: 'comments', icon: 'üí¨', title: t(lang, 'marketComments'), description: t(lang, 'marketCommentsDesc'), packagesKey: 'comments' },
    ],
  },
  tiktok: {
    label: t(lang, 'marketPlatformTikTok'),
    highlight: lang === 'es' ? 'Opciones optimizadas para TikTok.' : 'Optimized options for TikTok.',
    services: [
      { id: 'followers', icon: 'üöÄ', title: t(lang, 'marketFollowers'), description: lang === 'es' ? 'Acelera tu alcance en TikTok.' : 'Accelerate your TikTok reach.', packagesKey: 'followers' },
      { id: 'views', icon: '‚ö°', title: t(lang, 'marketViews'), description: lang === 'es' ? 'Impulsa views en TikTok y Reels.' : 'Boost TikTok and Reels views.', packagesKey: 'views' },
      { id: 'likes', icon: 'üî•', title: t(lang, 'marketLikes'), description: lang === 'es' ? 'Likes reales para tu feed.' : 'Real likes for your feed.', packagesKey: 'likes' },
      { id: 'live', icon: 'üé•', title: t(lang, 'marketLiveStream'), description: lang === 'es' ? 'Audiencia real en tus vivos.' : 'Real viewers for your lives.', packagesKey: 'live' },
    ],
  },
};

const checkoutSteps = ['basket', 'payment', 'confirm'];
const langStorageKey = 'clientky:lang';
const checkoutText = {
  processing: t(lang, 'marketFlowCheckoutProcessing'),
  confirmed: t(lang, 'marketFlowCheckoutConfirmed'),
  completed: t(lang, 'marketFlowCheckoutCompleted'),
};

const metrics = [
  {
    key: 'followers',
    label: t(lang, 'dashboardMetricFollowers'),
    value: '+2.8K',
    helper: t(lang, 'dashboardMetricFollowersHint'),
    accent: 'from-orange-100 to-pink-100',
  },
  {
    key: 'engagement',
    label: t(lang, 'dashboardMetricEngagement'),
    value: '6.2%',
    helper: t(lang, 'dashboardMetricEngagementHint'),
    accent: 'from-purple-100 to-indigo-100',
  },
  {
    key: 'reach',
    label: t(lang, 'dashboardMetricReach'),
    value: '1.2M',
    helper: t(lang, 'dashboardMetricReachHint'),
    accent: 'from-blue-100 to-cyan-100',
  },
  {
    key: 'conversions',
    label: t(lang, 'dashboardMetricConversions'),
    value: '9',
    helper: t(lang, 'dashboardMetricConversionsHint'),
    accent: 'from-green-100 to-emerald-100',
  },
];

const activityFeed = [
  {
    title: lang === 'es' ? 'Campa√±a de seguidores en progreso' : 'Follower campaign in progress',
    detail: lang === 'es' ? '356 acciones completadas hoy' : '356 actions completed today',
    time: lang === 'es' ? 'Hace 12 min' : '12 min ago',
  },
  {
    title: lang === 'es' ? 'Boost de likes para Reels' : 'Likes boost for Reels',
    detail: lang === 'es' ? '1.4K entregados / 2K objetivo' : '1.4K delivered / 2K goal',
    time: lang === 'es' ? 'Hace 1 hora' : '1 hour ago',
  },
  {
    title: lang === 'es' ? 'Reporte mensual listo' : 'Monthly report ready',
    detail: lang === 'es' ? 'Disponible en la secci√≥n de reportes' : 'Available inside reports section',
    time: lang === 'es' ? 'Hace 3 horas' : '3 hours ago',
  },
];


const networks = {
  instagram: {
    label: t(lang, 'dashboardInstagram'),
    username: '@leomessi',
    name: 'Leo Messi',
    posts: '1.436',
    followers: '509 M',
    following: '356',
    bio: lang === 'es'
      ? 'Bienvenidos a la cuenta oficial de Leo Messi.'
      : 'Welcome to the official Leo Messi Instagram account.',
    badge: 'IG',
    avatar: 'https://upload.wikimedia.org/wikipedia/commons/8/83/Lionel_Messi_20180626.jpg',
    link: 'https://instagram.com/leomessi',
  },
  tiktok: {
    label: t(lang, 'dashboardTikTok'),
    username: '@alfonsocattaneo',
    name: 'Alfonso Cattaneo',
    posts: '1.087',
    followers: '67.8 K',
    following: '68',
    bio: lang === 'es'
      ? 'Me llamo Alfonso y no me callo nunca.'
      : 'I am Alfonso and I never stay quiet.',
    badge: 'TT',
    avatar: 'https://images.unsplash.com/photo-1504593811423-6dd665756598?auto=format&fit=crop&w=320&q=60',
    link: 'https://www.tiktok.com/@alfonsocattaneo',
  },
};
const connectedNetworks = Object.keys(networks);
const defaultNetwork = connectedNetworks[0];

const planInfo = {
  name: lang === 'es' ? 'Starter Mensual' : 'Starter Monthly',
  renewal: lang === 'es' ? '15 dic 2024' : 'Dec 15, 2024',
  validity: lang === 'es' ? '15 ene 2025' : 'Jan 15, 2025',
  price: '$25',
};

const planInvoices = [
  { id: 'INV-2024-11', date: lang === 'es' ? '15 nov 2024' : 'Nov 15, 2024', amount: '$25', status: 'paid' },
  { id: 'INV-2024-10', date: lang === 'es' ? '15 oct 2024' : 'Oct 15, 2024', amount: '$25', status: 'paid' },
];

const marketplaceOrders = [
  {
    id: '#MK-9182',
    service: t(lang, 'marketFollowers'),
    details: 'Instagram ¬∑ 500',
    status: 'in-progress',
    eta: lang === 'es' ? 'ETA 2 h' : 'ETA 2 h',
    amount: '$39',
  },
  {
    id: '#MK-9044',
    service: t(lang, 'marketLikes'),
    details: 'TikTok ¬∑ 2.000',
    status: 'queued',
    eta: lang === 'es' ? 'En cola' : 'Queued',
    amount: '$29',
  },
  {
    id: '#MK-8810',
    service: t(lang, 'marketViews'),
    details: 'Instagram ¬∑ 25K',
    status: 'delivered',
    eta: lang === 'es' ? 'Entregado' : 'Delivered',
    amount: '$59',
  },
];

const reports = [
  {
    id: 'RPT-IG-2024-11',
    title: lang === 'es' ? 'Reporte mensual Instagram' : 'Monthly Instagram report',
    period: lang === 'es' ? 'Noviembre 2024' : 'November 2024',
    size: '2.1 MB ¬∑ PDF',
  },
  {
    id: 'RPT-TT-2024-11',
    title: lang === 'es' ? 'Reporte mensual TikTok' : 'Monthly TikTok report',
    period: lang === 'es' ? 'Noviembre 2024' : 'November 2024',
    size: '1.4 MB ¬∑ PDF',
  },
  {
    id: 'RPT-ADD-2024-10',
    title: lang === 'es' ? 'Compras adicionales Q4' : 'Q4 add-ons summary',
    period: lang === 'es' ? 'Octubre 2024' : 'October 2024',
    size: '900 KB ¬∑ XLSX',
  },
];

const supportCards = [
  {
    title: lang === 'es' ? 'Chat prioritario' : 'Priority chat',
    description: lang === 'es'
      ? 'Disponible de lunes a viernes, 9 a 18 h (GMT-3).'
      : 'Available Monday to Friday, 9am - 6pm (GMT-3).',
  },
  {
    title: lang === 'es' ? 'Tickets avanzados' : 'Advanced tickets',
    description: lang === 'es'
      ? 'Ideal para incidencias t√©cnicas o cambios en campa√±a.'
      : 'Ideal for technical incidents or campaign changes.',
  },
  {
    title: lang === 'es' ? 'Llamadas 1:1' : 'One-on-one calls',
    description: lang === 'es'
      ? 'Agend√° una sesi√≥n estrat√©gica con un especialista.'
      : 'Book a strategic session with a specialist.',
  },
];

const statusStyles = {
  'in-progress': 'bg-amber-100 text-amber-700',
  queued: 'bg-blue-100 text-blue-700',
  delivered: 'bg-emerald-100 text-emerald-700',
};

const statusLabels = {
  'in-progress': t(lang, 'dashboardOrderStatusInProgress'),
  queued: t(lang, 'dashboardOrderStatusQueued'),
  delivered: t(lang, 'dashboardOrderStatusDelivered'),
};
---

<Layout title={`Clientky - ${t(lang, 'dashboardPageTitle')}`} description={t(lang, 'dashboardPageSubtitle')} lang={lang}>
  <div class="min-h-screen bg-gray-50 py-24">
    <div class="max-w-7xl mx-auto flex flex-col lg:flex-row gap-8 px-6 xl:px-0">
      <aside class="w-full lg:w-64 bg-white rounded-3xl shadow-xl border border-gray-100 p-6">
        <a href={homeHref} class="inline-flex items-center gap-3 text-2xl font-bold text-primary mb-10">
          <span class="logo-isotype w-9 h-9" aria-hidden="true"></span>
          <span>Clientky<span class="text-gray-900">.</span></span>
        </a>

        <nav class="space-y-2">
          {navItems.map((item) => {
            const isDefault = item.key === defaultSection;
            return (
              <button
                type="button"
                class={`w-full flex items-center justify-between px-4 py-3 rounded-2xl text-sm font-semibold transition-all border ${
                  isDefault ? 'bg-primary text-white border-primary shadow-sm' : 'text-gray-600 border-gray-100 bg-gray-50 hover:bg-gray-100'
                }`}
                data-section-button
                data-target={item.key}
                aria-pressed={isDefault}
              >
                <span>{item.label}</span>
                <span aria-hidden="true">‚Ä¢</span>
              </button>
            );
          })}
        </nav>

        <div class="mt-8 space-y-4">
          <div class="flex items-center gap-3 p-4 rounded-3xl border border-gray-100 bg-gray-50">
            <div class="w-12 h-12 rounded-2xl overflow-hidden bg-gray-200">
              <img src={userProfile.avatar} alt={userProfile.name} class="w-full h-full object-cover" loading="lazy" />
            </div>
            <div>
              <p class="text-sm font-semibold text-gray-900">{userProfile.name}</p>
              <p class="text-xs text-gray-500">{userProfile.email}</p>
              <p class="text-xs text-gray-400">{userProfile.role}</p>
            </div>
          </div>

          <button
            type="button"
            class="w-full flex items-center justify-between px-4 py-3 rounded-2xl text-sm font-semibold border border-red-200 text-red-600 hover:bg-red-50 transition-all"
            data-logout-button
          >
            <span>{t(lang, 'dashboardNavLogout')}</span>
            <span aria-hidden="true">‚Üó</span>
          </button>
        </div>
      </aside>

      <main class="flex-1 space-y-10">
        <section data-section-panel="overview" class="space-y-8">
          <div class="bg-white rounded-3xl shadow-xl border border-gray-100 p-6 lg:p-8">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6 mb-6">
              <div>
                <p class="text-sm uppercase tracking-[0.3em] text-primary">
                  {t(lang, 'dashboardProfileTitle')}
                </p>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-900">
                  {t(lang, 'dashboardPageTitle')}
                </h1>
                <p class="text-gray-500">{t(lang, 'dashboardProfileSubtitle')}</p>
              </div>
              <div class="flex flex-col gap-2">
                <p class="text-xs text-gray-500 uppercase tracking-[0.3em]">
                  {t(lang, 'dashboardNetworkSelectorLabel')}
                </p>
                <div class="flex flex-wrap gap-2" role="tablist">
                  {connectedNetworks.map((network) => (
                    <button
                      type="button"
                      class={`px-4 py-2 rounded-2xl text-sm font-semibold border transition-all ${
                        network === defaultNetwork
                          ? 'bg-primary text-white border-primary'
                          : 'border-gray-200 text-gray-600 hover:border-primary/40'
                      }`}
                      data-network-button
                      data-network={network}
                      aria-pressed={network === defaultNetwork}
                    >
                      {networks[network].label}
                    </button>
                  ))}
                </div>
                <p class="text-xs text-gray-400">{t(lang, 'dashboardNetworkToggleHint')}</p>
              </div>
            </div>

            <div class="space-y-6">
              {connectedNetworks.map((network) => (
                <div
                  class={`border border-gray-100 rounded-3xl p-5 bg-gradient-to-br from-white to-gray-50 flex flex-col md:flex-row gap-6 ${
                    network !== defaultNetwork ? 'hidden' : ''
                  }`}
                  data-network-panel={network}
                >
                  <div class="flex items-center gap-4">
                    <div class="w-20 h-20 rounded-[28px] bg-gray-200 overflow-hidden">
                      <img src={networks[network].avatar} alt={networks[network].name} class="w-full h-full object-cover" loading="lazy" />
                    </div>
                    <div>
                      <p class="text-xs text-gray-500 uppercase tracking-[0.3em]">{networks[network].badge}</p>
                      <p class="text-xl font-bold text-gray-900">{networks[network].name}</p>
                      <a href={networks[network].link} target="_blank" rel="noreferrer" class="text-primary text-sm">
                        {networks[network].username}
                      </a>
                    </div>
                  </div>
                  <div class="flex-1 grid grid-cols-3 gap-4 text-center">
                    <div>
                      <p class="text-sm text-gray-500">{t(lang, 'dashboardMetricsPosts')}</p>
                      <p class="text-2xl font-bold text-gray-900">{networks[network].posts}</p>
                    </div>
                    <div>
                      <p class="text-sm text-gray-500">{t(lang, 'dashboardMetricsFollowers')}</p>
                      <p class="text-2xl font-bold text-gray-900">{networks[network].followers}</p>
                    </div>
                    <div>
                      <p class="text-sm text-gray-500">{t(lang, 'dashboardMetricsFollowing')}</p>
                      <p class="text-2xl font-bold text-gray-900">{networks[network].following}</p>
                    </div>
                  </div>
                  <div class="md:w-64">
                    <p class="text-xs uppercase tracking-[0.3em] text-gray-400">{t(lang, 'dashboardProfileBioLabel')}</p>
                    <p class="text-sm text-gray-600">{networks[network].bio}</p>
                  </div>
                </div>
              ))}
            </div>
          </div>

          <section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
            {metrics.map((metric) => (
              <div class={`rounded-3xl p-5 bg-gradient-to-br ${metric.accent} border border-white shadow`}>
                <p class="text-sm text-gray-600">{metric.label}</p>
                <p class="text-3xl font-bold text-gray-900 mt-2">{metric.value}</p>
                <p class="text-sm text-gray-500 mt-1">{metric.helper}</p>
              </div>
            ))}
          </section>

          <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-3xl border border-gray-100 shadow-xl p-6">
              <div class="flex items-center justify-between mb-6">
                <div>
                  <p class="text-sm uppercase tracking-[0.3em] text-primary">{t(lang, 'dashboardRealTimeTitle')}</p>
                  <p class="text-gray-500">{t(lang, 'dashboardRealTimeDesc')}</p>
                </div>
                <span class="px-3 py-1 text-xs bg-red-100 text-red-600 rounded-full font-semibold">LIVE</span>
              </div>
              <div class="space-y-4">
                {[...Array(5)].map((_, index) => (
                  <div class="flex items-center gap-3">
                    <div class="flex-1 h-3 rounded-full bg-gray-100 overflow-hidden">
                      <div class="h-full rounded-full bg-gradient-to-r from-primary to-secondary" style={`width: ${40 + index * 10}%`}></div>
                    </div>
                    <span class="text-sm text-gray-500">{index + 17} Nov</span>
                  </div>
                ))}
              </div>
            </div>

            <div class="bg-white rounded-3xl border border-gray-100 shadow-xl p-6">
              <div class="mb-6">
                <p class="text-sm uppercase tracking-[0.3em] text-primary">{t(lang, 'dashboardFeedTitle')}</p>
                <p class="text-gray-500">{t(lang, 'dashboardFeedDesc')}</p>
              </div>
              <div class="space-y-4">
                {activityFeed.map((item) => (
                  <div class="p-4 rounded-2xl border border-gray-100 bg-gray-50/70">
                    <p class="font-semibold text-gray-900">{item.title}</p>
                    <p class="text-sm text-gray-500">{item.detail}</p>
                    <p class="text-xs text-primary mt-2">{item.time}</p>
                  </div>
                ))}
              </div>
            </div>
          </section>
        </section>

        <section data-section-panel="orders" class="hidden space-y-6">
          <div class="bg-white rounded-3xl border border-gray-100 shadow-xl p-6">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
              <div>
                <p class="text-sm uppercase tracking-[0.3em] text-primary font-semibold">{t(lang, 'dashboardOrdersTitle')}</p>
                <p class="text-gray-500">{t(lang, 'dashboardOrdersSubtitle')}</p>
              </div>
              <a href={marketplaceAnchor} class="text-primary text-sm font-semibold hover:underline">
                {t(lang, 'dashboardMarketplaceCTA')}
              </a>
            </div>

            <div class="space-y-4">
              {marketplaceOrders.map((order) => (
                <div class="rounded-3xl border border-gray-100 p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                  <div>
                    <p class="text-sm text-gray-500">{order.id}</p>
                    <p class="text-lg font-semibold text-gray-900">{order.service}</p>
                    <p class="text-sm text-gray-500">{order.details}</p>
                  </div>
                  <div class="flex items-center gap-3">
                    <span class={`px-3 py-1 rounded-full text-xs font-semibold ${statusStyles[order.status]}`}>
                      {statusLabels[order.status]}
                    </span>
                    <span class="text-sm text-gray-500">{order.eta}</span>
                  </div>
                  <div class="flex items-center gap-4">
                    <span class="text-xl font-bold text-gray-900">{order.amount}</span>
                    <button class="text-primary text-sm font-semibold hover:underline">
                      {t(lang, 'dashboardOrderView')}
                    </button>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </section>

        <section data-section-panel="marketplace" class="hidden space-y-8">
          <div class="bg-white rounded-3xl border border-gray-100 shadow-xl p-6 lg:p-8 space-y-8">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
              <div>
                <p class="text-sm uppercase tracking-[0.3em] text-primary font-semibold mb-2">{t(lang, 'dashboardMarketplaceTitle')}</p>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">{t(lang, 'marketSelectTitle')}</h2>
                <p class="text-gray-500">{t(lang, 'dashboardMarketplaceSubtitle')}</p>
              </div>
              <button class="inline-flex items-center gap-2 border border-primary text-primary px-5 py-3 rounded-2xl font-semibold hover:bg-primary hover:text-white transition-colors">
                {t(lang, 'dashboardMarketplaceCTA')}
              </button>
            </div>

            <div id="marketplace-grid" class="space-y-6">
              <div>
                <p class="text-xs uppercase tracking-[0.3em] text-primary font-semibold mb-2">{t(lang, 'marketFlowPlatformSelectorLabel')}</p>
                <div class="flex flex-wrap gap-2" role="tablist">
                  {Object.entries(marketplacePlatforms).map(([platformKey, platformData]) => (
                    <button
                      type="button"
                      class={`px-4 py-2 rounded-2xl text-sm font-semibold border transition-all ${
                        platformKey === defaultMarketplacePlatform
                          ? 'bg-primary text-white border-primary'
                          : 'border-gray-200 text-gray-600 hover:border-primary/40'
                      }`}
                      data-marketplace-platform-button
                      data-platform={platformKey}
                      aria-pressed={platformKey === defaultMarketplacePlatform}
                    >
                      {platformData.label}
                    </button>
                  ))}
                </div>
                <p class="text-xs text-gray-400 mt-2">{t(lang, 'marketPlatformHint')}</p>
              </div>

              {Object.entries(marketplacePlatforms).map(([platformKey, platformData]) => (
                <div class={`${platformKey === defaultMarketplacePlatform ? '' : 'hidden'} space-y-4`} data-marketplace-panel={platformKey}>
                  <p class="text-sm text-gray-500">{platformData.highlight}</p>
                  <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5">
                    {platformData.services.map((service) => {
                      const packagesKey = service.packagesKey as keyof typeof marketplacePackages;
                      const firstPackage = marketplacePackages[packagesKey]?.[0];
                      return (
                        <article
                          class="rounded-3xl border border-gray-100 bg-gradient-to-br from-white to-gray-50 p-5 flex flex-col justify-between cursor-pointer hover:-translate-y-1 hover:shadow-lg transition-all"
                          role="button"
                          tabindex="0"
                          data-service-card
                          data-service={service.id}
                          data-platform={platformKey}
                          data-service-label={service.title}
                          data-platform-label={platformData.label}
                          data-packages-key={service.packagesKey}
                        >
                          <div class="space-y-3">
                            <span class="text-2xl" aria-hidden="true">{service.icon}</span>
                            <div>
                              <h3 class="text-lg font-semibold text-gray-900">{service.title}</h3>
                              <p class="text-sm text-gray-600">{service.description}</p>
                            </div>
                          </div>
                          <div class="mt-6 flex items-center justify-between text-sm">
                            <div class="text-left">
                              <p class="text-gray-500">{lang === 'es' ? 'Desde' : 'From'}</p>
                              <p class="text-lg font-semibold text-gray-900">
                                {firstPackage ? currencyFormatter.format(firstPackage.price) : '‚Äî'}
                              </p>
                            </div>
                            <span class="inline-flex items-center gap-1 text-primary font-semibold">
                              {t(lang, 'marketFlowStart')}
                              <span aria-hidden="true">‚Üí</span>
                            </span>
                          </div>
                        </article>
                      );
                    })}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </section>

        <section data-section-panel="reports" class="hidden space-y-6">
          <div class="bg-white rounded-3xl border border-gray-100 shadow-xl p-6">
            <div class="mb-6">
              <p class="text-sm uppercase tracking-[0.3em] text-primary font-semibold">{t(lang, 'dashboardReportsTitle')}</p>
              <p class="text-gray-500">{t(lang, 'dashboardReportsSubtitle')}</p>
            </div>
            <div class="space-y-4">
              {reports.map((report) => (
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 rounded-3xl border border-gray-100 p-4">
                  <div>
                    <p class="text-lg font-semibold text-gray-900">{report.title}</p>
                    <p class="text-sm text-gray-500">{report.period} ¬∑ {report.size}</p>
                  </div>
                  <button class="inline-flex items-center gap-2 text-sm font-semibold text-primary hover:underline">
                    {t(lang, 'dashboardReportDownload')}
                    <span aria-hidden="true">‚Üì</span>
                  </button>
                </div>
              ))}
            </div>
          </div>
        </section>

        <section data-section-panel="support" class="hidden space-y-6">
          <div class="bg-white rounded-3xl border border-gray-100 shadow-xl p-6 space-y-6">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
              <div>
                <p class="text-sm uppercase tracking-[0.3em] text-primary font-semibold">{t(lang, 'dashboardSupportTitle')}</p>
                <p class="text-gray-500">{t(lang, 'dashboardSupportSubtitle')}</p>
              </div>
              <button class="inline-flex items-center gap-2 bg-gradient-to-r from-primary to-secondary text-white px-5 py-3 rounded-2xl font-semibold shadow-lg">
                {t(lang, 'dashboardSupportCTA')}
              </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              {supportCards.map((card) => (
                <div class="rounded-3xl border border-gray-100 p-4 bg-gray-50/80">
                  <p class="font-semibold text-gray-900">{card.title}</p>
                  <p class="text-sm text-gray-500">{card.description}</p>
                </div>
              ))}
            </div>

            <div class="rounded-3xl border border-dashed border-primary/30 p-5 text-sm text-gray-600 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
              <div>
                <p class="font-semibold text-gray-900">{t(lang, 'dashboardSupportEmail')}</p>
                <p>{t(lang, 'dashboardSupportResponse')}: <strong>12h</strong></p>
              </div>
              <a href="mailto:soporte@clientky.com" class="text-primary font-semibold hover:underline">Email</a>
            </div>
          </div>
        </section>

        <section data-section-panel="plan" class="hidden space-y-6">
          <div class="bg-white rounded-3xl border border-gray-100 shadow-xl p-6 lg:p-8 space-y-8">
            <div>
              <p class="text-sm uppercase tracking-[0.3em] text-primary font-semibold">{t(lang, 'dashboardPlanSectionTitle')}</p>
              <h2 class="text-2xl font-bold text-gray-900">{planInfo.name}</h2>
              <p class="text-gray-500">{t(lang, 'dashboardPlanSectionSubtitle')}</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div class="rounded-3xl bg-gradient-to-r from-primary to-secondary text-white p-6 shadow-lg">
                <div class="flex items-center justify-between">
                  <p class="text-sm opacity-80">{t(lang, 'dashboardPlanLabel')}</p>
                  <span class="px-3 py-1 rounded-full text-xs font-semibold bg-white/20">
                    {t(lang, 'dashboardPlanStatusActive')}
                  </span>
                </div>
                <p class="text-3xl font-bold mt-4">{planInfo.price}</p>
                <p class="text-sm mt-2">{t(lang, 'dashboardPlanValidity')}: <strong>{planInfo.validity}</strong></p>
                <p class="text-sm">{t(lang, 'dashboardPlanRenewal')}: <strong>{planInfo.renewal}</strong></p>
                <div class="grid grid-cols-1 gap-2 mt-6">
                  <button class="w-full bg-white/20 hover:bg-white/30 rounded-2xl py-2 text-sm font-semibold transition-colors">
                    {t(lang, 'dashboardPlanUpgrade')}
                  </button>
                  <button class="w-full border border-white/30 rounded-2xl py-2 text-sm font-semibold bg-transparent hover:bg-white/15 transition-colors">
                    {t(lang, 'dashboardPlanDowngrade')}
                  </button>
                  <button class="w-full border border-red-200 text-red-50 rounded-2xl py-2 text-sm font-semibold bg-red-500/30 hover:bg-red-500/40 transition-colors">
                    {t(lang, 'dashboardPlanCancel')}
                  </button>
                </div>
              </div>

              <div class="rounded-3xl border border-gray-100 p-6 bg-gray-50">
                <p class="text-sm font-semibold text-gray-900">{t(lang, 'dashboardPlanBillingCycle')}</p>
                <p class="text-sm text-gray-600">{t(lang, 'dashboardPlanBillingCycleHint')}</p>
                <div class="mt-4 grid grid-cols-2 gap-4">
                  <div class="rounded-2xl bg-white p-4 border border-gray-100">
                    <p class="text-xs text-gray-500 uppercase tracking-[0.3em]">{t(lang, 'dashboardPlanValidity')}</p>
                    <p class="text-lg font-semibold text-gray-900">{planInfo.validity}</p>
                  </div>
                  <div class="rounded-2xl bg-white p-4 border border-gray-100">
                    <p class="text-xs text-gray-500 uppercase tracking-[0.3em]">{t(lang, 'dashboardPlanRenewal')}</p>
                    <p class="text-lg font-semibold text-gray-900">{planInfo.renewal}</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="rounded-3xl border border-gray-100 p-6 bg-white">
              <p class="text-sm font-semibold text-gray-900">{t(lang, 'dashboardPlanBillingHistory')}</p>
              <p class="text-xs text-gray-500 mb-4">{t(lang, 'dashboardPlanBillingSubtitle')}</p>
              <div class="space-y-3">
                {planInvoices.map((invoice) => (
                  <div class="flex items-center justify-between text-sm">
                    <div>
                      <p class="font-semibold text-gray-900">{invoice.id}</p>
                      <p class="text-xs text-gray-500">{invoice.date}</p>
                    </div>
                    <div class="flex items-center gap-3">
                      <span class="text-gray-900 font-semibold">{invoice.amount}</span>
                      <button class="text-primary text-xs font-semibold hover:underline">
                        {t(lang, 'dashboardPlanInvoice')}
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </section>

        <section data-section-panel="settings" class="hidden space-y-6">
          <div class="bg-white rounded-3xl border border-gray-100 shadow-xl p-6 lg:p-8 space-y-8">
            <div>
              <p class="text-sm uppercase tracking-[0.3em] text-primary font-semibold">{t(lang, 'dashboardSettingsTitle')}</p>
              <p class="text-gray-500">{t(lang, 'dashboardSettingsSubtitle')}</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <form class="rounded-3xl border border-gray-100 bg-gray-50 p-5 space-y-4" data-settings-form="password" data-success-message={t(lang, 'dashboardSettingsActionSuccess')}>
                <div>
                  <h3 class="text-lg font-semibold text-gray-900">{t(lang, 'dashboardSettingsPassword')}</h3>
                  <p class="text-sm text-gray-500">{t(lang, 'dashboardSettingsPasswordDesc')}</p>
                </div>
                <input
                  type="password"
                  name="new-password"
                  class="w-full rounded-2xl border border-gray-200 px-4 py-3 text-sm focus:border-primary focus:ring-primary"
                  placeholder={t(lang, 'dashboardSettingsPasswordPlaceholder')}
                  required
                />
                <button type="submit" class="w-full rounded-2xl bg-primary text-white py-3 text-sm font-semibold hover:opacity-90 transition">
                  {t(lang, 'dashboardSettingsPasswordButton')}
                </button>
                <p class="text-xs text-emerald-600 hidden" data-settings-feedback>{t(lang, 'dashboardSettingsActionSuccess')}</p>
              </form>

              <form class="rounded-3xl border border-gray-100 bg-gray-50 p-5 space-y-4" data-settings-form="email" data-success-message={t(lang, 'dashboardSettingsActionSuccess')}>
                <div>
                  <h3 class="text-lg font-semibold text-gray-900">{t(lang, 'dashboardSettingsEmail')}</h3>
                  <p class="text-sm text-gray-500">{t(lang, 'dashboardSettingsEmailDesc')}</p>
                </div>
                <input
                  type="email"
                  name="new-email"
                  class="w-full rounded-2xl border border-gray-200 px-4 py-3 text-sm focus:border-primary focus:ring-primary"
                  placeholder={t(lang, 'dashboardSettingsEmailPlaceholder')}
                  required
                />
                <button type="submit" class="w-full rounded-2xl bg-primary text-white py-3 text-sm font-semibold hover:opacity-90 transition">
                  {t(lang, 'dashboardSettingsEmailButton')}
                </button>
                <p class="text-xs text-emerald-600 hidden" data-settings-feedback>{t(lang, 'dashboardSettingsActionSuccess')}</p>
              </form>

              <div class="rounded-3xl border border-gray-100 bg-gray-50 p-5 space-y-4">
                <div>
                  <h3 class="text-lg font-semibold text-gray-900">{t(lang, 'dashboardSettingsLanguage')}</h3>
                  <p class="text-sm text-gray-500">{t(lang, 'dashboardSettingsLanguageDesc')}</p>
                </div>
                <div class="mt-2 space-y-2">
                  {preferredLanguages.map((option) => (
                    <label class="flex items-center justify-between rounded-2xl border border-gray-200 px-4 py-3 text-sm font-semibold text-gray-900">
                      <span>{option.label}</span>
                      <input type="radio" name="dashboard-language" value={option.value} data-language-option />
                    </label>
                  ))}
                </div>
                <p class="text-xs text-primary hidden" data-language-feedback>{t(lang, 'dashboardSettingsLanguageSaved')}</p>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <div class="fixed inset-0 z-50 hidden" data-marketplace-modal aria-hidden="true">
    <div class="absolute inset-0 bg-gray-900/50 backdrop-blur-sm" data-marketplace-close></div>
    <div class="relative max-w-3xl mx-auto px-4 py-10 h-full overflow-y-auto">
      <div class="bg-white rounded-3xl shadow-2xl border border-gray-100 p-6 lg:p-8 space-y-6" role="dialog" aria-modal="true">
        <div class="flex items-start justify-between gap-4">
          <div>
            <p class="text-xs uppercase tracking-[0.3em] text-gray-400">{t(lang, 'marketFlowServiceLabel')}</p>
            <p class="text-2xl font-bold text-gray-900" data-modal-service-label></p>
            <p class="text-sm text-gray-500">
              {t(lang, 'marketFlowPlatformSelectorLabel')}: <span data-modal-platform-label></span>
            </p>
          </div>
          <button type="button" class="text-sm text-gray-500 hover:text-gray-900" data-marketplace-close aria-label="Close">
            ‚úï
          </button>
        </div>

        <div class="flex flex-wrap gap-2" role="tablist">
          {Object.entries(marketplacePlatforms).map(([platformKey, platformData]) => (
            <button
              type="button"
              class="px-4 py-2 rounded-2xl text-sm font-semibold border border-gray-200 hover:border-primary/40"
              data-modal-platform-button
              data-platform={platformKey}
            >
              {platformData.label}
            </button>
          ))}
        </div>

        <div class="space-y-5" data-selection-wrapper>
          <div>
            <p class="text-sm font-semibold text-gray-900">{t(lang, 'marketFlowAccountTitle')}</p>
            <div class="mt-3 space-y-2" role="group">
              <label class="flex items-center gap-3 rounded-2xl border border-gray-200 px-4 py-3 cursor-pointer">
                <input type="radio" name="marketplace-account" value="saved" data-account-option checked />
                <div>
                  <p class="text-sm font-semibold text-gray-900">{t(lang, 'marketFlowAccountSaved')}</p>
                  <p class="text-xs text-gray-500">{userProfile.email}</p>
                </div>
              </label>
              <label class="flex items-center gap-3 rounded-2xl border border-gray-200 px-4 py-3 cursor-pointer">
                <input type="radio" name="marketplace-account" value="new" data-account-option />
                <div>
                  <p class="text-sm font-semibold text-gray-900">{t(lang, 'marketFlowAccountNew')}</p>
                  <p class="text-xs text-gray-500">{t(lang, 'marketFlowAccountPlaceholder')}</p>
                </div>
              </label>
            </div>
            <div class="mt-3 hidden" data-account-input-wrapper>
              <input
                type="url"
                class="w-full rounded-2xl border border-gray-200 px-4 py-3 text-sm focus:border-primary focus:ring-primary"
                placeholder={t(lang, 'marketFlowAccountPlaceholder')}
                data-account-field
              />
            </div>
          </div>

          <div>
            <div class="flex items-center justify-between gap-4 flex-wrap">
              <div>
                <p class="text-sm font-semibold text-gray-900">{t(lang, 'marketFlowPackagesTitle')}</p>
                <p class="text-xs text-gray-500">{t(lang, 'marketFlowPackagesSubtitle')}</p>
              </div>
              <p class="text-xs text-gray-400" data-package-hint>{t(lang, 'marketFlowSelectPackageHint')}</p>
            </div>

            <div class="mt-4 space-y-3" data-package-wrapper>
              {Object.entries(marketplacePackages).map(([serviceKey, packages]) => (
                <div data-package-panel={serviceKey} class="grid grid-cols-1 md:grid-cols-2 gap-3 hidden">
                  {packages.map((pkg) => {
                    const unitLabel = serviceUnits[serviceKey as keyof typeof serviceUnits] ?? '';
                    const quantityLabel = `${quantityFormatter.format(pkg.quantity)} ${unitLabel}`;
                    return (
                      <button
                        type="button"
                        class="rounded-2xl border border-gray-200 bg-white p-4 text-left transition hover:border-primary/60 focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/40"
                        data-package-option
                        data-service-key={serviceKey}
                        data-price={pkg.price}
                        data-label={quantityLabel}
                      >
                        <p class="text-sm font-semibold text-gray-900">{quantityLabel}</p>
                        <p class="text-2xl font-bold text-gray-900">{currencyFormatter.format(pkg.price)}</p>
                        {pkg.compareAt && (
                          <p class="text-xs text-gray-500">
                            <span class="line-through mr-1">{currencyFormatter.format(pkg.compareAt)}</span>
                            {pkg.discount ? <span class="text-emerald-600 font-semibold">-{pkg.discount}%</span> : null}
                          </p>
                        )}
                      </button>
                    );
                  })}
                </div>
              ))}
            </div>
          </div>

          <div class="flex items-center justify-between rounded-3xl border border-gray-100 bg-gray-50 p-4 flex-wrap gap-4">
            <div>
              <p class="text-xs uppercase tracking-[0.3em] text-gray-500">{t(lang, 'marketFlowTotalLabel')}</p>
              <p class="text-2xl font-bold text-gray-900" data-marketplace-total>{currencyFormatter.format(0)}</p>
            </div>
            <button
              type="button"
              class="px-6 py-3 rounded-2xl font-semibold text-white bg-primary disabled:bg-gray-300 disabled:text-gray-500 transition"
              data-add-to-basket
              disabled
            >
              {t(lang, 'marketFlowAddToBasket')}
            </button>
          </div>
        </div>

        <div class="space-y-4 hidden" data-checkout-sim>
          <div class="rounded-3xl border border-primary/30 bg-primary/5 p-4">
            <p class="text-sm font-semibold text-primary">{t(lang, 'marketFlowCheckoutTitle')}</p>
            <p class="text-xs text-gray-600" data-checkout-status>{t(lang, 'marketFlowCheckoutProcessing')}</p>
          </div>
          <div class="space-y-3">
            {checkoutSteps.map((step) => (
              <div class="flex items-center justify-between rounded-2xl border border-gray-200 p-4" data-checkout-step={step}>
                <div>
                  <p class="text-sm font-semibold text-gray-900">
                    {step === 'basket'
                      ? t(lang, 'marketFlowCheckoutStepBasket')
                      : step === 'payment'
                      ? t(lang, 'marketFlowCheckoutStepPayment')
                      : t(lang, 'marketFlowCheckoutStepConfirm')}
                  </p>
                  <p class="text-xs text-gray-500" data-step-status></p>
                </div>
                <span class="w-3 h-3 rounded-full bg-gray-200" data-step-indicator></span>
              </div>
            ))}
          </div>
          <p class="text-sm font-semibold text-emerald-600 hidden" data-checkout-result>{t(lang, 'marketFlowCheckoutDone')}</p>
          <button type="button" class="w-full rounded-2xl border border-gray-200 py-3 text-sm font-semibold hover:border-primary hover:text-primary transition" data-finish-checkout>
            {t(lang, 'marketFlowClose')}
          </button>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script define:vars={{ defaultSection, defaultMarketplacePlatform, lang, loginHref, checkoutSteps, langStorageKey, checkoutText }}>
  const DEFAULT_SECTION = defaultSection;
  const DEFAULT_MARKETPLACE_PLATFORM = defaultMarketplacePlatform;
  const DASHBOARD_LANG = lang;
  const LOGIN_HREF = loginHref;
  const CHECKOUT_STEPS = checkoutSteps;
  const LANG_STORAGE_KEY = langStorageKey;
  const currencyFormatter = new Intl.NumberFormat(DASHBOARD_LANG === 'es' ? 'es-AR' : 'en-US', { style: 'currency', currency: 'USD' });
  const CHECKOUT_TEXT = checkoutText;

  const sectionButtons = document.querySelectorAll('[data-section-button]');
  const sectionPanels = document.querySelectorAll('[data-section-panel]');

  function setActiveSection(target) {
    sectionButtons.forEach((button) => {
      const isActive = button.getAttribute('data-target') === target;
      button.classList.toggle('bg-primary', isActive);
      button.classList.toggle('text-white', isActive);
      button.classList.toggle('border-primary', isActive);
      button.classList.toggle('text-gray-600', !isActive);
      button.classList.toggle('bg-gray-100', !isActive);
      button.setAttribute('aria-pressed', String(isActive));
    });

    sectionPanels.forEach((panel) => {
      panel.classList.toggle('hidden', panel.getAttribute('data-section-panel') !== target);
    });
  }

  sectionButtons.forEach((button) => {
    button.addEventListener('click', () => {
      const target = button.getAttribute('data-target');
      if (target) {
        setActiveSection(target);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    });
  });

  setActiveSection(DEFAULT_SECTION);

  const networkButtons = document.querySelectorAll('[data-network-button]');
  const networkPanels = document.querySelectorAll('[data-network-panel]');

  networkButtons.forEach((button) => {
    button.addEventListener('click', () => {
      const target = button.getAttribute('data-network');
      networkButtons.forEach((btn) => {
        const isActive = btn === button;
        btn.classList.toggle('bg-primary', isActive);
        btn.classList.toggle('text-white', isActive);
        btn.classList.toggle('border-primary', isActive);
        btn.classList.toggle('text-gray-600', !isActive);
        btn.classList.toggle('border-gray-200', !isActive);
        btn.setAttribute('aria-pressed', String(isActive));
      });
      networkPanels.forEach((panel) => {
        panel.classList.toggle('hidden', panel.getAttribute('data-network-panel') !== target);
      });
    });
  });

  const marketplacePlatformButtons = document.querySelectorAll('[data-marketplace-platform-button]');
  const marketplacePanels = document.querySelectorAll('[data-marketplace-panel]');

  function setMarketplacePlatform(target) {
    marketplacePlatformButtons.forEach((button) => {
      const isActive = button.getAttribute('data-platform') === target;
      button.classList.toggle('bg-primary', isActive);
      button.classList.toggle('text-white', isActive);
      button.classList.toggle('border-primary', isActive);
      button.classList.toggle('text-gray-600', !isActive);
      button.classList.toggle('border-gray-200', !isActive);
      button.setAttribute('aria-pressed', String(isActive));
    });

    marketplacePanels.forEach((panel) => {
      panel.classList.toggle('hidden', panel.getAttribute('data-marketplace-panel') !== target);
    });
  }

  marketplacePlatformButtons.forEach((button) => {
    button.addEventListener('click', () => {
      const target = button.getAttribute('data-platform');
      if (target) {
        setMarketplacePlatform(target);
      }
    });
  });

  if (marketplacePlatformButtons.length) {
    setMarketplacePlatform(DEFAULT_MARKETPLACE_PLATFORM);
  }

  const languageRadios = document.querySelectorAll('[data-language-option]');
  const languageFeedback = document.querySelector('[data-language-feedback]');

  try {
    const storedLang = window.localStorage.getItem(LANG_STORAGE_KEY);
    if (storedLang && storedLang !== DASHBOARD_LANG) {
      const redirectPath = storedLang === 'en' ? '/en/dashboard/' : '/dashboard/';
      if (window.location.pathname !== redirectPath) {
        window.location.replace(redirectPath);
      }
    }
  } catch (error) {
    // ignore storage errors
  }

  languageRadios.forEach((radio) => {
    radio.checked = radio.value === DASHBOARD_LANG;
    radio.addEventListener('change', () => {
      try {
        window.localStorage.setItem(LANG_STORAGE_KEY, radio.value);
      } catch (error) {
        // ignore storage errors
      }
      if (languageFeedback) {
        languageFeedback.classList.remove('hidden');
      }
      const redirectPath = radio.value === 'en' ? '/en/dashboard/' : '/dashboard/';
      if (window.location.pathname !== redirectPath) {
        setTimeout(() => {
          window.location.href = redirectPath;
        }, 400);
      }
    });
  });

  const settingsForms = document.querySelectorAll('[data-settings-form]');
  settingsForms.forEach((form) => {
    form.addEventListener('submit', (event) => {
      event.preventDefault();
      const feedback = form.querySelector('[data-settings-feedback]');
      if (feedback) {
        feedback.classList.remove('hidden');
        setTimeout(() => feedback.classList.add('hidden'), 2500);
      }
      form.reset();
    });
  });

  const logoutButtons = document.querySelectorAll('[data-logout-button]');
  logoutButtons.forEach((button) => {
    button.addEventListener('click', () => {
      try {
        window.localStorage.removeItem(LANG_STORAGE_KEY);
      } catch (error) {
        // ignore storage errors
      }
      window.location.href = LOGIN_HREF;
    });
  });

  const marketplaceModal = document.querySelector('[data-marketplace-modal]');
  const serviceCards = document.querySelectorAll('[data-service-card]');
  const modalCloseElements = document.querySelectorAll('[data-marketplace-close]');
  const modalPlatformButtons = marketplaceModal?.querySelectorAll('[data-modal-platform-button]') ?? [];
  const modalServiceLabel = marketplaceModal?.querySelector('[data-modal-service-label]');
  const modalPlatformLabel = marketplaceModal?.querySelector('[data-modal-platform-label]');
  const packagePanels = marketplaceModal?.querySelectorAll('[data-package-panel]') ?? [];
  const packageOptions = marketplaceModal?.querySelectorAll('[data-package-option]') ?? [];
  const selectionWrapper = marketplaceModal?.querySelector('[data-selection-wrapper]');
  const checkoutWrapper = marketplaceModal?.querySelector('[data-checkout-sim]');
  const totalValueEl = marketplaceModal?.querySelector('[data-marketplace-total]');
  const addToBasketBtn = marketplaceModal?.querySelector('[data-add-to-basket]');
  const packageHint = marketplaceModal?.querySelector('[data-package-hint]');
  const checkoutStatus = marketplaceModal?.querySelector('[data-checkout-status]');
  const checkoutResult = marketplaceModal?.querySelector('[data-checkout-result]');
  const checkoutStepElements = marketplaceModal?.querySelectorAll('[data-checkout-step]') ?? [];
  const finishCheckoutButtons = marketplaceModal?.querySelectorAll('[data-finish-checkout]') ?? [];
  const accountRadios = marketplaceModal?.querySelectorAll('[data-account-option]') ?? [];
  const accountInputWrapper = marketplaceModal?.querySelector('[data-account-input-wrapper]');

  const modalState = {
    service: null,
    packagesKey: null,
    platform: DEFAULT_MARKETPLACE_PLATFORM,
    selectedPackage: null,
  };

  const checkoutTimers = [];

  function clearCheckoutTimers() {
    checkoutTimers.forEach((timerId) => window.clearTimeout(timerId));
    checkoutTimers.length = 0;
  }

  function resetPackageSelection() {
    packageOptions.forEach((option) => {
      option.classList.remove('border-primary', 'bg-primary/5', 'ring-2', 'ring-primary/40');
    });
    modalState.selectedPackage = null;
    if (totalValueEl) {
      totalValueEl.textContent = currencyFormatter.format(0);
    }
    if (addToBasketBtn) {
      addToBasketBtn.disabled = true;
    }
    if (packageHint) {
      packageHint.classList.remove('text-emerald-600');
    }
  }

  function showPackagePanel(serviceKey) {
    packagePanels.forEach((panel) => {
      const matches = panel.getAttribute('data-package-panel') === serviceKey;
      panel.classList.toggle('hidden', !matches);
    });
  }

  function setModalPlatform(target) {
    modalState.platform = target;
    modalPlatformButtons.forEach((button) => {
      const isActive = button.getAttribute('data-platform') === target;
      button.classList.toggle('bg-primary', isActive);
      button.classList.toggle('text-white', isActive);
      button.classList.toggle('border-primary', isActive);
      button.classList.toggle('text-gray-600', !isActive);
      button.classList.toggle('border-gray-200', !isActive);
    });
    const activeButton = Array.from(modalPlatformButtons).find((button) => button.getAttribute('data-platform') === target);
    if (modalPlatformLabel && activeButton) {
      modalPlatformLabel.textContent = activeButton.textContent?.trim() ?? '';
    }
  }

  function openMarketplaceModal({ service, platform, serviceLabel, packagesKey }) {
    if (!marketplaceModal) return;
    modalState.service = service;
    modalState.packagesKey = packagesKey || service;
    modalState.platform = platform || DEFAULT_MARKETPLACE_PLATFORM;
    marketplaceModal.classList.remove('hidden');
    marketplaceModal.setAttribute('aria-hidden', 'false');
    document.body.classList.add('overflow-hidden');
    if (modalServiceLabel) {
      modalServiceLabel.textContent = serviceLabel || '';
    }
    setModalPlatform(modalState.platform);
    showPackagePanel(modalState.packagesKey);
    resetPackageSelection();
    if (selectionWrapper) selectionWrapper.classList.remove('hidden');
    if (checkoutWrapper) checkoutWrapper.classList.add('hidden');
    if (checkoutStatus) checkoutStatus.textContent = CHECKOUT_TEXT.processing;
    checkoutResult?.classList.add('hidden');
    accountRadios.forEach((radio, index) => {
      radio.checked = index === 0;
    });
    accountInputWrapper?.classList.add('hidden');
  }

  function closeMarketplaceModal() {
    if (!marketplaceModal) return;
    marketplaceModal.classList.add('hidden');
    marketplaceModal.setAttribute('aria-hidden', 'true');
    document.body.classList.remove('overflow-hidden');
    resetPackageSelection();
    if (selectionWrapper) selectionWrapper.classList.remove('hidden');
    if (checkoutWrapper) checkoutWrapper.classList.add('hidden');
    if (checkoutStatus) checkoutStatus.textContent = CHECKOUT_TEXT.processing;
    checkoutResult?.classList.add('hidden');
    clearCheckoutTimers();
  }

  function startCheckoutSimulation() {
    if (!marketplaceModal || !checkoutWrapper || !selectionWrapper) return;
    selectionWrapper.classList.add('hidden');
    checkoutWrapper.classList.remove('hidden');
    if (checkoutStatus) checkoutStatus.textContent = CHECKOUT_TEXT.processing;
    checkoutResult?.classList.add('hidden');
    checkoutStepElements.forEach((stepEl) => {
      stepEl.classList.remove('border-primary', 'bg-primary/5');
      const indicator = stepEl.querySelector('[data-step-indicator]');
      indicator?.classList.remove('bg-primary');
      const status = stepEl.querySelector('[data-step-status]');
      if (status) status.textContent = '';
    });
    clearCheckoutTimers();
    CHECKOUT_STEPS.forEach((step, index) => {
      const timer = window.setTimeout(() => {
        const stepEl = marketplaceModal.querySelector(`[data-checkout-step="${step}"]`);
        if (!stepEl) return;
        stepEl.classList.add('border-primary', 'bg-primary/5');
        const indicator = stepEl.querySelector('[data-step-indicator]');
        indicator?.classList.add('bg-primary');
        const status = stepEl.querySelector('[data-step-status]');
        if (status) {
          status.textContent =
            step === 'basket'
              ? CHECKOUT_TEXT.processing
              : step === 'payment'
              ? CHECKOUT_TEXT.confirmed
              : CHECKOUT_TEXT.completed;
        }
        if (index === CHECKOUT_STEPS.length - 1) {
          checkoutResult?.classList.remove('hidden');
        }
      }, 800 * (index + 1));
      checkoutTimers.push(timer);
    });
  }

  serviceCards.forEach((card) => {
    function handleCardClick() {
      const service = card.getAttribute('data-service');
      const platform = card.getAttribute('data-platform');
      const serviceLabel = card.getAttribute('data-service-label');
      const packagesKey = card.getAttribute('data-packages-key');
      openMarketplaceModal({
        service,
        platform,
        serviceLabel,
        packagesKey,
      });
    }

    card.addEventListener('click', handleCardClick);
    card.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        handleCardClick();
      }
    });
  });

  modalPlatformButtons.forEach((button) => {
    button.addEventListener('click', () => {
      const target = button.getAttribute('data-platform');
      if (target) {
        setModalPlatform(target);
      }
    });
  });

  packageOptions.forEach((option) => {
    function selectOption() {
      const parentPanel = option.closest('[data-package-panel]');
      if (parentPanel?.classList.contains('hidden')) return;
      packageOptions.forEach((btn) => {
        btn.classList.remove('border-primary', 'bg-primary/5', 'ring-2', 'ring-primary/40');
      });
      option.classList.add('border-primary', 'bg-primary/5', 'ring-2', 'ring-primary/40');
      const price = parseFloat(option.getAttribute('data-price') ?? '0');
      const label = option.getAttribute('data-label') ?? '';
      modalState.selectedPackage = { price, label };
      if (totalValueEl) {
        totalValueEl.textContent = currencyFormatter.format(price);
      }
      if (addToBasketBtn) {
        addToBasketBtn.disabled = price <= 0;
      }
      if (packageHint) {
        packageHint.classList.add('text-emerald-600');
      }
    }

    option.addEventListener('click', selectOption);
    option.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        selectOption();
      }
    });
  });

  if (addToBasketBtn) {
    addToBasketBtn.addEventListener('click', () => {
      if (!modalState.selectedPackage) return;
      startCheckoutSimulation();
    });
  }

  modalCloseElements.forEach((element) => {
    element.addEventListener('click', closeMarketplaceModal);
  });

  finishCheckoutButtons.forEach((button) => button.addEventListener('click', closeMarketplaceModal));

  document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape' && marketplaceModal && !marketplaceModal.classList.contains('hidden')) {
      closeMarketplaceModal();
    }
  });

  accountRadios.forEach((radio) => {
    radio.addEventListener('change', () => {
      if (!accountInputWrapper) return;
      if (radio.checked && radio.value === 'new') {
        accountInputWrapper.classList.remove('hidden');
      } else if (radio.checked) {
        accountInputWrapper.classList.add('hidden');
      }
    });
  });
</script>
